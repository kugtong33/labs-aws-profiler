#!/usr/bin/env bash
#
# awsprof - AWS Profile Manager
# https://github.com/ubuntu/labs-aws-profiler
#

# Only set strict mode when running as script, not when sourced
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    set -euo pipefail
fi

#=== CONFIGURATION ===
_awsprof_version="1.0.0"
_awsprof_credentials="${AWS_SHARED_CREDENTIALS_FILE:-$HOME/.aws/credentials}"
_awsprof_config="${AWS_CONFIG_FILE:-$HOME/.aws/config}"
AWSPROF_EMOJI="${AWSPROF_EMOJI:-0}"

#=== OUTPUT UTILITIES ===
# awsprof_msg - Output message to stderr
# awsprof_error - Output error message to stderr
# awsprof_warn - Output warning message to stderr
# awsprof_success - Output success message to stderr

awsprof_msg() {
    echo "$*" >&2
}

awsprof_error() {
    awsprof_msg "Error: $*"
}

awsprof_warn() {
    awsprof_msg "Warning: $*"
}

awsprof_success() {
    awsprof_msg "$*"
}

#=== INI HANDLING ===
# awsprof_ini_list_sections - List all profile sections from credentials file
# awsprof_ini_read_section - Read key-value pairs from a specific section

awsprof_ini_list_sections() {
    local file="${1:-$_awsprof_credentials}"

    # Check if file exists
    if [[ ! -f "$file" ]]; then
        awsprof_error "Credentials file not found: $file"
        return 1
    fi

    # Extract section names using awk
    local errexit_was_set=0
    [[ $- == *e* ]] && errexit_was_set=1
    set +e
    awk '
        /^\[/ {
            if ($0 !~ /^\[[^][]+\]$/) {
                print "Error: Malformed INI section header at line " NR ": " $0 > "/dev/stderr"
                exit 2
            }
            gsub(/^\[|\]$/, "")
            print
        }
    ' "$file"
    local awk_status=$?
    if [[ $errexit_was_set -eq 1 ]]; then
        set -e
    fi
    if [[ $awk_status -ne 0 ]]; then
        if [[ $awk_status -ne 2 ]]; then
            awsprof_error "Failed to parse credentials file: $file"
        fi
        return 1
    fi

    return 0
}

awsprof_ini_read_section() {
    local section="$1"
    local file="${2:-$_awsprof_credentials}"

    # Check if file exists
    if [[ ! -f "$file" ]]; then
        awsprof_error "Credentials file not found: $file"
        return 1
    fi

    # Check if section parameter provided
    if [[ -z "$section" ]]; then
        awsprof_error "Section name required"
        return 1
    fi

    # Read section content using awk
    local errexit_was_set=0
    [[ $- == *e* ]] && errexit_was_set=1
    set +e
    awk -F' *= *' -v section="[$section]" '
        /^\[/ {
            if ($0 !~ /^\[[^][]+\]$/) {
                print "Error: Malformed INI section header at line " NR ": " $0 > "/dev/stderr"
                exit 2
            }
            found = ($0 == section)
            next
        }
        found && $0 !~ /^[ \t]*($|[;#])/ && index($0, "=") == 0 {
            print "Error: Malformed INI key/value at line " NR ": " $0 > "/dev/stderr"
            exit 2
        }
        found && /^[^#;]/ && NF >= 2 {
            key = $1
            gsub(/^[ \t]+|[ \t]+$/, "", key)
            val = $2
            for (i = 3; i <= NF; i++) val = val "=" $i
            gsub(/^[ \t]+|[ \t]+$/, "", val)
            print key "=" val
        }
    ' "$file"
    local awk_status=$?
    if [[ $errexit_was_set -eq 1 ]]; then
        set -e
    fi
    if [[ $awk_status -ne 0 ]]; then
        if [[ $awk_status -ne 2 ]]; then
            awsprof_error "Failed to read section '$section' from: $file"
        fi
        return 1
    fi

    return 0
}

#=== PROFILE COMMANDS ===
# awsprof_cmd_list - List available profiles
# awsprof_cmd_use - Switch to a profile
# awsprof_cmd_whoami - Show current profile

awsprof_cmd_list() {
    local profiles
    profiles=$(awsprof_ini_list_sections) || return 1

    if [[ -z "$profiles" ]]; then
        awsprof_msg "No profiles found"
        return 0
    fi

    echo "$profiles"
    return 0
}

awsprof_cmd_use() {
    local profile_name="$1"

    # Validate parameter provided
    if [[ -z "$profile_name" ]]; then
        awsprof_error "Profile name required"
        awsprof_msg "Usage: awsprof use <profile-name>"
        return 1
    fi

    # Validate profile exists
    local profiles
    profiles=$(awsprof_ini_list_sections) || return 1

    if ! echo "$profiles" | grep -qx "$profile_name"; then
        awsprof_error "Profile '$profile_name' not found"
        return 1
    fi

    # Output eval code to stdout
    echo "export AWS_PROFILE=$profile_name"

    # Output success message to stderr
    awsprof_success "Switched to profile: $profile_name"

    return 0
}

awsprof_cmd_whoami() {
    # Check if AWS_PROFILE is set and non-empty
    if [[ -n "${AWS_PROFILE:-}" ]]; then
        # Output current profile to stdout
        echo "$AWS_PROFILE"
    else
        # Output default message to stdout
        echo "No profile set (using default)"
    fi

    return 0
}

#=== MAIN DISPATCH ===
# Main command dispatcher

# If script is sourced (for testing), don't run main
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    case "${1:-}" in
        list)
            awsprof_cmd_list
            exit $?
            ;;
        use)
            awsprof_cmd_use "${2:-}"
            exit $?
            ;;
        whoami)
            awsprof_cmd_whoami
            exit $?
            ;;
        help|--help|-h|"")
            awsprof_msg "awsprof v${_awsprof_version}"
            awsprof_msg "Usage: awsprof <command>"
            awsprof_msg ""
            awsprof_msg "Commands:"
            awsprof_msg "  list              List available AWS profiles"
            awsprof_msg "  use <profile>     Switch to a profile (use with eval)"
            awsprof_msg "  whoami            Show currently active profile"
            exit 0
            ;;
        *)
            awsprof_error "Unknown command: ${1}"
            exit 1
            ;;
    esac
fi
